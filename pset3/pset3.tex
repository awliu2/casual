% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
\PassOptionsToPackage{dvipsnames,svgnames,x11names}{xcolor}
%
\documentclass[
]{article}
\usepackage{amsmath,amssymb}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math} % this also loads fontspec
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
\usepackage{lmodern}
\ifPDFTeX\else
  % xetex/luatex font selection
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\usepackage[margin=1in]{geometry}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{-\maxdimen} % remove section numbering
\usepackage{amsmath}
\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same}
\hypersetup{
  pdftitle={Problem Set 3},
  pdfauthor={Tessie Dong, Derek Li, Andi Liu},
  colorlinks=true,
  linkcolor={Maroon},
  filecolor={Maroon},
  citecolor={Blue},
  urlcolor={Blue},
  pdfcreator={LaTeX via pandoc}}

\title{Problem Set 3}
\author{Tessie Dong, Derek Li, Andi Liu}
\date{Due Jan 18th, 2024}

\begin{document}
\maketitle

\textbf{Part 1: Describe the Data} \newline Combine the NSW data in
\texttt{nswre74\_control.csv} and \texttt{nswre74\_treated.csv} and
complete Table \ref{tab:Tab_NSW_1}. Note that variables \texttt{1-10}
are \(\color{ForestGreen}{predetermined}\), i.e., capture
characteristics determined at or before treatment assignment; some of
these variables are background characteristics (e.g., \texttt{edu}),
others capture a subject's pre-RCT labor market experience (e.g.,
\texttt{u75}). \texttt{re78} is the observed outcome variable.
\texttt{treat} is the indicator of treatment status.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# load and combine the data sets into one dataframe}
\NormalTok{df1 }\OtherTok{\textless{}{-}}\NormalTok{ utils}\SpecialCharTok{::}\FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file =} \StringTok{"nswre74\_control.csv"}\NormalTok{)}
\NormalTok{df2 }\OtherTok{\textless{}{-}}\NormalTok{ utils}\SpecialCharTok{::}\FunctionTok{read.csv}\NormalTok{(}\AttributeTok{file =} \StringTok{"nswre74\_treated.csv"}\NormalTok{)}
\NormalTok{df }\OtherTok{\textless{}{-}} \FunctionTok{rbind}\NormalTok{(df1, df2)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# count units in each sample}
\NormalTok{dplyr}\SpecialCharTok{::}\FunctionTok{tally}\NormalTok{(dplyr}\SpecialCharTok{::}\FunctionTok{group\_by}\NormalTok{(df, treat))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 2 x 2
##   treat     n
##   <int> <int>
## 1     0   260
## 2     1   185
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# generate mean summary statistics for each variable and treatment}
\NormalTok{dplyr}\SpecialCharTok{::}\FunctionTok{summarise\_all}\NormalTok{((dplyr}\SpecialCharTok{::}\FunctionTok{group\_by}\NormalTok{(df, treat)), }\FunctionTok{list}\NormalTok{(mean))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 2 x 12
##   treat   age   edu black   hisp married nodegree  re74  re75  re78   u74   u75
##   <int> <dbl> <dbl> <dbl>  <dbl>   <dbl>    <dbl> <dbl> <dbl> <dbl> <dbl> <dbl>
## 1     0  25.1  10.1 0.827 0.108    0.154    0.835 2107. 1267. 4555. 0.75  0.685
## 2     1  25.8  10.3 0.843 0.0595   0.189    0.708 2096. 1532. 6349. 0.708 0.6
\end{verbatim}

A completed version of Table 1 is provided on the following page.
\newpage

\begin{table}[!ht!]
\centering
\begin{tabular}{ccccc}
\hline
\textbf{Variable} & \textbf{Variable}    & \textbf{Variable}    & \multicolumn{2}{c}{\textbf{Sample Average}}    \\ \cline{4-5} 
\textbf{Counter} & \textbf{Name}       & \textbf{Definition}                        & \textbf{Treated} & \textbf{Control} \\ \hline
1 & \texttt{age}      & Age in years                      & 25.8        & 25.1       \\
2 & \texttt{edu}      & Education in years                & 10.3        & 10.1       \\
3 & \texttt{nodegree} & 1 if education $<12$              & 0.708       & 0.835      \\
4 & \texttt{black}    & 1 if Black                        & 0.843       & 0.827      \\
5 & \texttt{hisp}     & 1 if Hispanic                     & 0.0595      & 0.108      \\
6 & \texttt{married}  & 1 if married                      & 0.189       & 0.154      \\
7 & \texttt{u74}      & 1 if unemployed in '74            & 0.708       & 0.75       \\
8 & \texttt{u75}      & 1 if unemployed in '75            & 0.6         & 0.685      \\
9 & \texttt{re74}     & Real earnings in '74 (in '82 \$)  & 2096        & 2107       \\
10 & \texttt{re75}    & Real earnings in '75 (in '82 \$)  & 1532        & 1267       \\
\hline 
11 & \texttt{re78}    & Real earnings in '78 (in '82 \$)  & 6349        & 4555       \\
12 & \texttt{treat}   & 1 if received offer of training   & 1           & 0          \\
\hline
Sample Size                                             &&& 185         & 260              \\ \hline
\end{tabular}
\caption{Descriptive statistics for the NSW data by group.}
\label{tab:Tab_NSW_1}
\end{table}

\textbf{Part 2: Test Balance}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Test \textcolor{ForestGreen}{balance} for each of the 10 OPVs in Table
  (\ref{tab:Tab_NSW_1}), i.e., test that each variable's mean is the
  same in the control and treated groups. Do so by running 10 simple
  linear regressions (SLR) specifications. Use a 5\% significance level
  and look at the relevant 10 t-tests, comment on your findings.
  \textcolor{gray}{\textbf{Hint}: Each OPV is the dependent variable in its regression equation. All 10 SLR models have the same covariates.}
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ols\_p\_values }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{ols\_coefficients }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{ols\_se }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{vars }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(df)[}\DecValTok{2}\SpecialCharTok{:}\DecValTok{12}\NormalTok{]}
\ControlFlowTok{for}\NormalTok{ (var }\ControlFlowTok{in}\NormalTok{ vars) \{}
\NormalTok{    formula }\OtherTok{\textless{}{-}}\NormalTok{ stats}\SpecialCharTok{::}\FunctionTok{formula}\NormalTok{(}\FunctionTok{paste}\NormalTok{(var, }\StringTok{"\textasciitilde{}treat"}\NormalTok{))}
\NormalTok{    lm\_model }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(}\AttributeTok{formula =}\NormalTok{ formula, }\AttributeTok{data =}\NormalTok{ df)}
\NormalTok{    ols\_p\_values[[var]] }\OtherTok{\textless{}{-}} \FunctionTok{summary}\NormalTok{(lm\_model)}\SpecialCharTok{$}\NormalTok{coefficients[}\DecValTok{2}\NormalTok{, }\DecValTok{4}\NormalTok{]}
\NormalTok{    ols\_coefficients[[var]] }\OtherTok{\textless{}{-}} \FunctionTok{summary}\NormalTok{(lm\_model)}\SpecialCharTok{$}\NormalTok{coefficients[}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{]}
\NormalTok{    ols\_se[[var]] }\OtherTok{\textless{}{-}} \FunctionTok{summary}\NormalTok{(lm\_model)}\SpecialCharTok{$}\NormalTok{coefficients[}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{]}
\NormalTok{\}}
\CommentTok{\# print(ols\_p\_values)}
\CommentTok{\# print(ols\_coefficients)}
\CommentTok{\# print(ols\_se)}
\end{Highlighting}
\end{Shaded}

\begin{table}
\centering
\begin{tabular}{ccccc}
\hline
& \textbf{Variable} & \textbf{Coefficient} & \textbf{se} & \textbf{p-value} \\ \hline
1 & \texttt{age} & 0.7623701 & 0.6827511 & 0.264764 \\
2 & \texttt{edu} & 0.2574844 & 0.1721353 & 0.135411 \\
3 & \texttt{nodegree} & -0.1265073 & 0.0393452 & 0.001398 \\
4 & \texttt{black} & 0.01632017 & 0.03588617 & 0.649493 \\
5 & \texttt{hisp} & -0.04823285& 0.0271632 & 0.076474 \\
6 & \texttt{married} & 0.03534304 & 0.03604844 & 0.327408 \\
7 & \texttt{u74} & -0.04189189& 0.0426221 & 0.326209 \\
8 & \texttt{u75} & -0.08461538& 0.04582176 & 0.065469 \\
9 & \texttt{re74} & -11.45296 & 516.478 & 0.982318 \\
10 & \texttt{re75} & 265.1463 & 303.1555 & 0.382254 \\ \hline
\end{tabular}
\caption{Coefficients, standard errors, and p-values for the t-tests of balance for each OPV.}
\end{table}

Table 2 shows the p-values for the t-tests of balance for each OPV.
\newline  We can see that for most of our variables, the p-value is
greater than 0.05, so we fail to reject the null hypothesis that the
means are the same in the control and treated groups. However, for
\texttt{nodegree} we reject the null hypothesis that the means are the
same in the control and treated groups, and we cannot claim that these
groups are balanced for this variable.

\newpage

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  Testing balance as done in Q1 suffers from the so called
  \href{https://en.wikipedia.org/wiki/Multiple_comparisons_problem}{\textcolor{ForestGreen}{``multiple comparisons''}}
  or \textcolor{ForestGreen}{``multiple testing'' problem} which occurs
  when one considers a set of statistical inferences simultaneously. The
  \href{https://explainxkcd.com/wiki/index.php/882:_Significant}{problem}
  emerges because as more variables are compared, it becomes more likely
  that the treatment and control groups appear to differ on at least one
  attribute \textit{by random chance alone}. To deal with this problem
  we use an estimation methodology called
  \textcolor{ForestGreen}{SUR estimation} and then test just one
  hypothesis, the \textit{joint} hypothesis that all OPVs are balanced,
  i.e., their means are the same in the two groups. SUR stands for
  \textcolor{ForestGreen}{seemingly unrelated regression} and it is a
  special case of
  \textcolor{ForestGreen}{feasible Generalized Least Squares (GLS) estimation}.
  Instead of estimating the coefficients \textit{equation-by-equation}
  by OLS (and done in Q1 you combine the 10 equations in a system of
  equations and estimate the coefficients present in all the equations
  jointly, accounting for the fact that the unobservables may be
  correlated across equations within an individual (we continue to
  assume that they are uncorrelated across units). After estimation, you
  use standard testing procedures to test the \textit{joint} hypothesis
  that the slope coefficients in all the equations of the SUR system are
  zero. This joint test is a test of covariate balance that does not
  suffer from the ``multiple testing'\,' problem.
\end{enumerate}

\begin{enumerate}
\def\labelenumi{\alph{enumi}.}
\tightlist
\item
  Estimate the SUR system. Are the estimated coefficients and their SEs
  different from those obtained in Q1? Comment.
  \textcolor{gray}{\textbf{Hint}: In 2 situations there is no efficiency payoff to GLS versus OLS: 1) the unobservables are uncorrelated across equations within an individual; and 2) the equations have identical covariates.}
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# create a list of formulas for each equation}
\NormalTok{formulas }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\NormalTok{vars }\OtherTok{\textless{}{-}} \FunctionTok{names}\NormalTok{(df)[}\DecValTok{2}\SpecialCharTok{:}\DecValTok{12}\NormalTok{]}
\ControlFlowTok{for}\NormalTok{ (var }\ControlFlowTok{in}\NormalTok{ vars) \{}
\NormalTok{  formulas[[var]] }\OtherTok{\textless{}{-}} \FunctionTok{formula}\NormalTok{(}\FunctionTok{paste}\NormalTok{(var, }\StringTok{"\textasciitilde{}treat"}\NormalTok{))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# estimate the SUR model}
\NormalTok{sur\_fit }\OtherTok{\textless{}{-}}\NormalTok{ systemfit}\SpecialCharTok{::}\FunctionTok{systemfit}\NormalTok{(}\AttributeTok{formula =}\NormalTok{ formulas, }\AttributeTok{data =}\NormalTok{ df, }\AttributeTok{method =} \StringTok{"SUR"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# print the coefficients and SE of the SUR model}
\NormalTok{i }\OtherTok{\textless{}{-}} \DecValTok{1}
\ControlFlowTok{while}\NormalTok{ (i }\SpecialCharTok{\textless{}=} \DecValTok{11}\NormalTok{)\{}
  \FunctionTok{print}\NormalTok{(}\FunctionTok{sprintf}\NormalTok{(}\StringTok{"\%s: \%f, \%f"}\NormalTok{,}
\NormalTok{                vars[i],}
                \FunctionTok{summary}\NormalTok{(sur\_fit)}\SpecialCharTok{$}\NormalTok{coefficients[i }\SpecialCharTok{*} \DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{],}
                \FunctionTok{summary}\NormalTok{(sur\_fit)}\SpecialCharTok{$}\NormalTok{coefficients[i }\SpecialCharTok{*} \DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{]))}
\NormalTok{  i }\OtherTok{\textless{}{-}}\NormalTok{ (i }\SpecialCharTok{+} \DecValTok{1}\NormalTok{)}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "age: 0.762370, 0.682751"
## [1] "edu: 0.257484, 0.172135"
## [1] "black: 0.016320, 0.035886"
## [1] "hisp: -0.048233, 0.027163"
## [1] "married: 0.035343, 0.036048"
## [1] "nodegree: -0.126507, 0.039345"
## [1] "re74: -11.452958, 516.477971"
## [1] "re75: 265.146299, 303.155497"
## [1] "re78: 1794.342382, 632.853392"
## [1] "u74: -0.041892, 0.042622"
## [1] "u75: -0.084615, 0.045822"
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# print the coefficients and SE of the OLS model}
\ControlFlowTok{for}\NormalTok{ (var }\ControlFlowTok{in}\NormalTok{ vars)}
\NormalTok{\{}
  \FunctionTok{print}\NormalTok{(}\FunctionTok{sprintf}\NormalTok{(}\StringTok{"\%s: \%f, \%f "}\NormalTok{, var, ols\_coefficients[var], ols\_se[var]))}
\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "age: 0.762370, 0.682751 "
## [1] "edu: 0.257484, 0.172135 "
## [1] "black: 0.016320, 0.035886 "
## [1] "hisp: -0.048233, 0.027163 "
## [1] "married: 0.035343, 0.036048 "
## [1] "nodegree: -0.126507, 0.039345 "
## [1] "re74: -11.452958, 516.477971 "
## [1] "re75: 265.146299, 303.155497 "
## [1] "re78: 1794.342382, 632.853392 "
## [1] "u74: -0.041892, 0.042622 "
## [1] "u75: -0.084615, 0.045822 "
\end{verbatim}

The estimated coefficients and SEs are the same across OLS and GLS
estimations for all the OPVs. This result may be due to the fact that
the equations have the same covariate, i.e.~\texttt{treat}.

\begin{enumerate}
\def\labelenumi{\alph{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  Test \textit{joint} balance by testing the
  \textcolor{ForestGreen}{joint hypothesis} that the coefficients of
  \texttt{treat} are zero in all the equations of the system. Spell out
  null and alternative hypotheses, comment on findings, and verify the
  test's value and p-value ``manually.'\,'
  \textcolor{gray}{\textbf{Hint}: Use the \href{https://en.wikipedia.org/wiki/Likelihood-ratio_test}{\textcolor{ForestGreen}{Likelihood Ratio (LR) test}} where the unrestricted model is the system of equations with \texttt{treat} as covariate, and the restricted model is the system with no regression covariates, i.e., with only the constant term. To verify the value of the test use its algebraic expression. Recall that the test has a $\chi^{2}_{df}$ distribution with $df$ = number of restrictions.}
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# create a list of formulas null\_system with only the constant}
\NormalTok{null\_formulas }\OtherTok{\textless{}{-}} \FunctionTok{list}\NormalTok{()}
\ControlFlowTok{for}\NormalTok{ (var }\ControlFlowTok{in}\NormalTok{ vars) \{}
\NormalTok{  null\_formulas[[var]] }\OtherTok{\textless{}{-}} \FunctionTok{formula}\NormalTok{(}\FunctionTok{paste}\NormalTok{(var, }\StringTok{"\textasciitilde{}1"}\NormalTok{))}
\NormalTok{\}}

\CommentTok{\# pass the null\_system to systemfit}
\NormalTok{null\_fit }\OtherTok{\textless{}{-}}\NormalTok{ systemfit}\SpecialCharTok{::}\FunctionTok{systemfit}\NormalTok{(}\AttributeTok{formula =}\NormalTok{ null\_formulas, }\AttributeTok{data =}\NormalTok{ df, }\AttributeTok{method =} \StringTok{"SUR"}\NormalTok{)}

\CommentTok{\# calculate the LR test statistic}
\NormalTok{lrtest\_obj }\OtherTok{\textless{}{-}}\NormalTok{ lmtest}\SpecialCharTok{::}\FunctionTok{lrtest}\NormalTok{(null\_fit, sur\_fit)}
\NormalTok{lr\_statistic }\OtherTok{\textless{}{-}}\NormalTok{ lrtest\_obj}\SpecialCharTok{$}\NormalTok{Chisq[}\DecValTok{2}\NormalTok{]}
\NormalTok{lr\_df }\OtherTok{\textless{}{-}}\NormalTok{ lrtest\_obj}\SpecialCharTok{$}\NormalTok{Df[}\DecValTok{2}\NormalTok{]}

\NormalTok{p\_value }\OtherTok{\textless{}{-}}\NormalTok{ stats}\SpecialCharTok{::}\FunctionTok{pchisq}\NormalTok{(lr\_statistic, }\AttributeTok{df =}\NormalTok{ lr\_df, }\AttributeTok{lower.tail =} \ConstantTok{FALSE}\NormalTok{)}
\FunctionTok{print}\NormalTok{(}\FunctionTok{sprintf}\NormalTok{(}\StringTok{"LR test statistic: \%f, p{-}value: \%f"}\NormalTok{, lr\_statistic, p\_value))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "LR test statistic: 27.021898, p-value: 0.004560"
\end{verbatim}

The null hypothesis is that the coefficients of \texttt{treat} are zero
in all the equations of the system. The alternative hypothesis is that
there is at least one equation with a nonzero coefficient, implying that
the control and treatment groups have different means for an OPV.

The p-value of this test is significant (p-value \textless{} 0.05). This
result shows that we can reject null hypothesis that the coefficients of
\texttt{treat} are zero in all the equations of the system, implying
that the assignment of treatment did not balance all the subjects'
characteristics.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{2}
\item
  Test that the OPVs do not predict treatment assignment. Spell out null
  and alternative hypotheses, comment on findings, and verify the test's
  value and p-value ``manually.'\,' Why would scientists carry out this
  test?
  \textcolor{gray}{\textbf{Hint:} Use a MLRM and the \textcolor{ForestGreen}{F-test for the overall significance of the regression}. \textbf{Programming guidance}: Use \texttt{summary()} after estimation, e.g., \texttt{summary(lm\_fit)\$fstatistic} returns the test's value and degrees of freedom. Use \href{https://stat.ethz.ch/R-manual/R-devel/library/stats/html/Fdist.html}{\texttt{stats::pf()}} to verify the test's p-value.}

  We want to test that, given the covariates, the treatment assignment
  is random. We can do this by testing that the coefficients of the
  covariates are zero in the regression of treatment assignment on the
  covariates. \newline

  Given \((Y, X^{OPV})\) where \(Y\) represents the treatment
  assignment, and \(X\) is a vector of our OPV covariates, we can test
  the following model: \(Y = \beta'X^{OPV} + \epsilon\) with these
  hypotheses: \newline  \[ 
   \begin{cases}
   H_0: \beta = 0 \\
   H_1: \beta \neq 0 
   \end{cases}
   \] In which \(\beta\) is a vector of coefficients for the OPV
  covariates. Thus, we want \(\beta = 0\), i.e the OPV covariates all
  have no correlation to the treatment \(Y\).
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# create a list of formulas for each equation}

\NormalTok{lm\_fit }\OtherTok{\textless{}{-}} \FunctionTok{lm}\NormalTok{(}\AttributeTok{formula =} \FunctionTok{formula}\NormalTok{(}\FunctionTok{paste}\NormalTok{(}\StringTok{"treat"}\NormalTok{, }\StringTok{"\textasciitilde{}"}\NormalTok{, }\FunctionTok{paste}\NormalTok{(vars, }\AttributeTok{collapse =} \StringTok{"+"}\NormalTok{))), }\AttributeTok{data =}\NormalTok{ df)}
\CommentTok{\# summary(lm\_fit)}
\CommentTok{\# summary(lm\_fit)$fstatistic}
\NormalTok{f\_stat }\OtherTok{\textless{}{-}} \FunctionTok{summary}\NormalTok{(lm\_fit)}\SpecialCharTok{$}\NormalTok{fstatistic[}\DecValTok{1}\NormalTok{]}
\NormalTok{numdf }\OtherTok{\textless{}{-}} \FunctionTok{summary}\NormalTok{(lm\_fit)}\SpecialCharTok{$}\NormalTok{fstatistic[}\DecValTok{2}\NormalTok{]}
\NormalTok{dendf }\OtherTok{\textless{}{-}} \FunctionTok{summary}\NormalTok{(lm\_fit)}\SpecialCharTok{$}\NormalTok{fstatistic[}\DecValTok{3}\NormalTok{]}
\NormalTok{p\_val }\OtherTok{\textless{}{-}}\NormalTok{ stats}\SpecialCharTok{::}\FunctionTok{pf}\NormalTok{(f\_stat,numdf,dendf)}

\FunctionTok{sprintf}\NormalTok{(}\StringTok{"The p{-}value of the ftest is: \%f"}\NormalTok{, p\_val)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] "The p-value of the ftest is: 0.994656"
\end{verbatim}

With a p-value of 0.994656, we conclude that there is not enough
evidence to reject the null hypothesis that OPVs do not predict
treatment assignment. This result implies that proper random assignment
was carried out such that treatment was given randomly irrespective of
the subjects' characteristics. Scientists carry out this test to ensure
that the treatment and control groups are similar in all respects except
for the treatment itself.

\textbf{Part 3: Estimate the Effect of the Offer of Training}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Implement specs 0 (3 p) and 1 (2 p). Describe your findings.
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stats}\SpecialCharTok{::}\FunctionTok{t.test}\NormalTok{(df1}\SpecialCharTok{$}\NormalTok{re78, df2}\SpecialCharTok{$}\NormalTok{re78)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  Welch Two Sample t-test
## 
## data:  df1$re78 and df2$re78
## t = -2.6741, df = 307.13, p-value = 0.007893
## alternative hypothesis: true difference in means is not equal to 0
## 95 percent confidence interval:
##  -3114.6743  -474.0105
## sample estimates:
## mean of x mean of y 
##  4554.801  6349.144
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{spec1 }\OtherTok{=}\NormalTok{ stats}\SpecialCharTok{::}\FunctionTok{lm}\NormalTok{(}\AttributeTok{data=}\NormalTok{df, re78 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ treat)}
\FunctionTok{summary}\NormalTok{(spec1)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## stats::lm(formula = re78 ~ treat, data = df)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
##  -6349  -4555  -1829   2917  53959 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(>|t|)    
## (Intercept)   4554.8      408.0  11.162  < 2e-16 ***
## treat         1794.3      632.9   2.835  0.00479 ** 
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 6580 on 443 degrees of freedom
## Multiple R-squared:  0.01782,    Adjusted R-squared:  0.01561 
## F-statistic: 8.039 on 1 and 443 DF,  p-value: 0.004788
\end{verbatim}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  Implement specs 2 through 4.
\end{enumerate}

\begin{enumerate}
\def\labelenumi{\alph{enumi}.}
\tightlist
\item
  Report the estimates of the ATE and test \(H_0\) that ATE is zero (3 p
  each spec).
  \textcolor{gray}{\textbf{Hint:} You consider spec 2 in light of the imbalance in educational attainment documented in Part 2. This approach to account for the presence of observable confounders (i.e., imbalance in OPVs) is called the \textcolor{ForestGreen}{regression adjustment approach}. Spec 3 has 11 regression covariates. Spec 4 has 12 regression covariates.}
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{spec2 }\OtherTok{=}\NormalTok{ stats}\SpecialCharTok{::}\FunctionTok{lm}\NormalTok{(}\AttributeTok{data=}\NormalTok{df, re78 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ treat }\SpecialCharTok{+} \FunctionTok{factor}\NormalTok{(nodegree) }\SpecialCharTok{+}\NormalTok{ edu)}
\FunctionTok{summary}\NormalTok{(spec2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## stats::lm(formula = re78 ~ treat + factor(nodegree) + edu, data = df)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
##  -7570  -4762  -1708   3129  53900 
## 
## Coefficients:
##                   Estimate Std. Error t value Pr(>|t|)  
## (Intercept)         1741.4     2889.8   0.603   0.5471  
## treat               1645.9      638.0   2.580   0.0102 *
## factor(nodegree)1   -518.3      984.0  -0.527   0.5987  
## edu                  321.8      224.9   1.431   0.1533  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 6554 on 441 degrees of freedom
## Multiple R-squared:  0.02988,    Adjusted R-squared:  0.02328 
## F-statistic: 4.527 on 3 and 441 DF,  p-value: 0.003862
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{spec3 }\OtherTok{=}\NormalTok{ stats}\SpecialCharTok{::}\FunctionTok{lm}\NormalTok{(}\AttributeTok{data=}\NormalTok{df, re78 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ treat }\SpecialCharTok{+} \FunctionTok{factor}\NormalTok{(nodegree) }\SpecialCharTok{+}\NormalTok{ edu }\SpecialCharTok{+}\NormalTok{ age }\SpecialCharTok{+} \FunctionTok{factor}\NormalTok{(black) }\SpecialCharTok{+} \FunctionTok{factor}\NormalTok{(hisp) }\SpecialCharTok{+} \FunctionTok{factor}\NormalTok{(married) }\SpecialCharTok{+}\NormalTok{ re74 }\SpecialCharTok{+}\NormalTok{ re75 }\SpecialCharTok{+} \FunctionTok{factor}\NormalTok{(u74) }\SpecialCharTok{+} \FunctionTok{factor}\NormalTok{(u75))}
\FunctionTok{summary}\NormalTok{(spec3)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## stats::lm(formula = re78 ~ treat + factor(nodegree) + edu + age + 
##     factor(black) + factor(hisp) + factor(married) + re74 + re75 + 
##     factor(u74) + factor(u75), data = df)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
##  -9612  -4355  -1572   3054  53119 
## 
## Coefficients:
##                     Estimate Std. Error t value Pr(>|t|)   
## (Intercept)        2.567e+02  3.522e+03   0.073  0.94193   
## treat              1.671e+03  6.411e+02   2.606  0.00948 **
## factor(nodegree)1 -1.518e+01  1.006e+03  -0.015  0.98797   
## edu                4.008e+02  2.288e+02   1.751  0.08058 . 
## age                5.357e+01  4.581e+01   1.170  0.24284   
## factor(black)1    -2.037e+03  1.174e+03  -1.736  0.08331 . 
## factor(hisp)1      4.258e+02  1.565e+03   0.272  0.78562   
## factor(married)1  -1.463e+02  8.823e+02  -0.166  0.86834   
## re74               1.234e-01  8.784e-02   1.405  0.16080   
## re75               1.974e-02  1.503e-01   0.131  0.89554   
## factor(u74)1       1.380e+03  1.188e+03   1.162  0.24590   
## factor(u75)1      -1.071e+03  1.025e+03  -1.045  0.29651   
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 6517 on 433 degrees of freedom
## Multiple R-squared:  0.05822,    Adjusted R-squared:  0.0343 
## F-statistic: 2.433 on 11 and 433 DF,  p-value: 0.005974
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df}\SpecialCharTok{$}\NormalTok{age\_dev }\OtherTok{=}\NormalTok{ (df}\SpecialCharTok{$}\NormalTok{age }\SpecialCharTok{{-}} \FunctionTok{mean}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{age))}\SpecialCharTok{/}\FunctionTok{sd}\NormalTok{(df}\SpecialCharTok{$}\NormalTok{age)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{spec4 }\OtherTok{=}\NormalTok{ stats}\SpecialCharTok{::}\FunctionTok{lm}\NormalTok{(}\AttributeTok{data=}\NormalTok{df, re78 }\SpecialCharTok{\textasciitilde{}}\NormalTok{ treat }\SpecialCharTok{+} \FunctionTok{factor}\NormalTok{(nodegree) }\SpecialCharTok{+}\NormalTok{ edu }\SpecialCharTok{+}\NormalTok{ age }\SpecialCharTok{+} \FunctionTok{factor}\NormalTok{(black) }\SpecialCharTok{+} \FunctionTok{factor}\NormalTok{(hisp) }\SpecialCharTok{+} \FunctionTok{factor}\NormalTok{(married) }\SpecialCharTok{+}\NormalTok{ re74 }\SpecialCharTok{+}\NormalTok{ re75 }\SpecialCharTok{+} \FunctionTok{factor}\NormalTok{(u74) }\SpecialCharTok{+} \FunctionTok{factor}\NormalTok{(u75) }\SpecialCharTok{+}\NormalTok{ age\_dev }\SpecialCharTok{*}\NormalTok{ treat)}

\FunctionTok{summary}\NormalTok{(spec4)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
## Call:
## stats::lm(formula = re78 ~ treat + factor(nodegree) + edu + age + 
##     factor(black) + factor(hisp) + factor(married) + re74 + re75 + 
##     factor(u74) + factor(u75) + age_dev * treat, data = df)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
##  -9655  -4340  -1549   2979  52961 
## 
## Coefficients: (1 not defined because of singularities)
##                     Estimate Std. Error t value Pr(>|t|)   
## (Intercept)        1.079e+03  3.624e+03   0.298  0.76612   
## treat              1.660e+03  6.413e+02   2.588  0.00998 **
## factor(nodegree)1  4.570e+00  1.006e+03   0.005  0.99638   
## edu                4.070e+02  2.289e+02   1.778  0.07616 . 
## age                1.837e+01  5.858e+01   0.314  0.75394   
## factor(black)1    -1.988e+03  1.175e+03  -1.692  0.09138 . 
## factor(hisp)1      4.807e+02  1.566e+03   0.307  0.75900   
## factor(married)1  -1.740e+02  8.828e+02  -0.197  0.84386   
## re74               1.230e-01  8.785e-02   1.400  0.16218   
## re75               1.281e-02  1.505e-01   0.085  0.93222   
## factor(u74)1       1.359e+03  1.188e+03   1.144  0.25321   
## factor(u75)1      -1.124e+03  1.026e+03  -1.095  0.27402   
## age_dev                   NA         NA      NA       NA   
## treat:age_dev      6.079e+02  6.307e+02   0.964  0.33563   
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 6517 on 432 degrees of freedom
## Multiple R-squared:  0.06024,    Adjusted R-squared:  0.03414 
## F-statistic: 2.308 on 12 and 432 DF,  p-value: 0.007352
\end{verbatim}

\begin{enumerate}
\def\labelenumi{\alph{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  Are there reasons to add OPVs as covariates when they are balanced
  across treatment and control groups? If so, what are they? Comment on
  the estimation results from specs 2 and 3.
\end{enumerate}

We can add additional OPVs even if they're balanced across the treatment
and control groups because even with no systematic differences between
the groups, those variables may still possibly contribute some causal
effect on the outcome. By regressing on those variables, we can remove
some variance in the treatment effect that may be attributed to those
OPVs. Additionally, even in randomized experiments, some imbalance can
occur purely by chance. In spec 2, the p-value is not as significant as
the p-value in spec 3.

\begin{enumerate}
\def\labelenumi{\alph{enumi}.}
\setcounter{enumi}{2}
\tightlist
\item
  With reference to spec 3, do you think that it is problematic to use
  lagged / past values of the dependent variable as regression
  covariates? Explain.
\end{enumerate}

No.~It is common practice in time series analysis to regress on lagged
values of the dependent variable. Though some assumptions must be
upheld. In this case specifically, it seems alright as the past values
of earnings show no significant effect on earnings in 1978 as a result
of the t-test.

\begin{enumerate}
\def\labelenumi{\alph{enumi}.}
\setcounter{enumi}{3}
\tightlist
\item
  Are there reasons to add interactions between OPVs and the treatment
  indicator? If so, what are they? With reference to spec 4, test the
  following two hypothesis: i) the ATE is zero; ii) the effect of the
  treatment does not vary by the age of the subject. \textbf{Note:} If
  additional assumptions are needed to carry out i) and ii), state them.
  \textcolor{gray}{\textbf{Programming Guidance}: Use \href{https://rdrr.io/cran/car/man/linearHypothesis.html}{\texttt{car::linearHypothesis()}}.}
\end{enumerate}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{2}
\tightlist
\item
  Brainstorm on the possible mechanisms for the estimated ATE of being
  offered training.
  \textcolor{gray}{\textbf{Hint:} Can you think of the possible pathways through which on-the-job training may cause an increase in post-intervention earnings?}\label{item:oot:ate-vs-ite}
\end{enumerate}

A potential mechanism for the estimated ATE of being offered training
could be that if an individual who if offered training accepts and
undergoes the training, they may received skill enhancement which will
enable them to secure better-paying positions that have more skill
requirements. Another possible mechanism for the estimated ATE of being
offered training is suggested by the footnote, that an individual might
become more optimistic about their prospects and therefore works harder
to land a well-paying job, even without actually going through the
training.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{3}
\tightlist
\item
  Starting with Hint 1, we express \((y_{1i}^o, y_{0i}^o)\) in terms of
  \((y_{1i}, y_{0i})\). First, recognize that individuals that are not
  offered training, cannot take up training. This means that the
  earnings of individuals not offered training, are a subset of the
  group of individuals that do not take up training. We can assert that
  \(y_{0i}^o = y_{0i}\) by recognizing this relationship.

  \par\medskip

  Then, recognize that individuals that are offered training, have a 0.5
  probability of accepting or rejecting the offer of training.
  Individuals who accept the offer compose the group of individuals that
  recieve training. Individuals who reject the offer are part of the a
  subset of the group of individuals that do not take up training. This
  can be expressed as \begin{align*}
   y_{1i}^o &= \mathbb{P}[\text{accept offer}]y_{1i} + \mathbb{P}[\text{reject offer}]y_{0i}\\ 
   &= \frac{1}{2}y_{1i} + \frac{1}{2}y_{0i}.
  \end{align*} We then find the following relationship between \(ATE\)
  and \(ATE^o\): \begin{align*}
   ATE^o &= \mathbb{E}[y_{1i}^o - y_{0i}^o]\\
   &= \mathbb{E}[(\frac{1}{2}y_{1i} + \frac{1}{2}y_{0i}) - y_{0i}] \text{, by definition, }\\
   &= \mathbb{E}[\frac{1}{2}y_{1i} - \frac{1}{2}y_{0i}]\\
   &= \frac{1}{2}\mathbb{E}[y_{1i} - y_{0i}] \text{, by linearity, }\\
   &= \frac{1}{2}ATE.
  \end{align*} Using this model we have shown that the two average
  treatment effects are different. Particularly that the Intent to Treat
  effect is of captured as a proportion of the Average Treatement Effect
  of recieving training.
\end{enumerate}

\end{document}
